# Установка и настройка OpenVPN (сервер/клиент)

## Подготовка:
>В VirtualBOX установлены две виртуальные машины: Ubuntu Server 22.04 и Ubuntu Desktop 22.04.<br>
Данные машины имеют доступ в интернет и объеденены друг с другом виртуальной локальной сетью.<br>
Для удобства настройки, была заранее создана общая папка для обеих систем.

## Настраиваем сервер:
```
// Устанавливаем брандмауер
sudo apt install ufw

// Задаём правила по умолчанию
sudo ufw default deny incoming
sudo ufw default allow outgoing
```
## Устанавливаем OpenVPN сервер:
```
// Предварительно открываем нужный порт в брандмауере
sudo ufw allow 1194/tcp
sudo ufw allow 1194/udp
sudo ufw enable

// Скачиваем скрипт автоустановки OpenVPN
wget https://git.io/vpn -O openvpn-install.sh

// Запускаем скрипт автоустановки
sudo bash openvpn-install.sh

// Задаём параметры
[
    IP - HOST IP; 
    PORT - 1194; 
    DNS - ANY (FOR EXAMPLE: 1.1.1.1);
    CONFIG NAME - ANY (FOR EXAMLE: client);
]

// После установки, OpenVPN сервер уже в работе
[CONFIG ADDRESS: /etc/openvpn/server/server.conf]

// Скрипт сам генерирует конфиг для клиента
[CONFIG ADDRESS: root/client.ovpn]

// Переместим его в общую папку
mv root/client.ovpn [YOUR FOLDER]
mv client.ovpn client.conf
```

## Настраиваем клиент:
```
// Устанавливаем OpenVPN
sudo apt install openvpn

// Перемещаем конфиг клиента в нужную папку
mv [YOUR FOLDER]/client.conf etc/openvpn/client

// Перезапускаем OpenVPN
sudo systemctl restart openvpn
```
## Крнфигурируем сервер:

>Перед каждым действием выполняем: `sudo ufw reset`
```

// Конфигурация № 1: Сервер пропускает через себя любой трафик только от клиента
sudo ufw allow from [CLIENT IP]

// Конфигурация № 2: Сервер пропускает через себя трафик от клиента и от хостовой машины
sudo ufw allow from [CLIENT IP]
sudo ufw allow from [HOST IP]

// Конфигурация № 3: Сервер пропускает через себя только udp-траффик от клиента или tcp-траффик от хостовой машины
sudo ufw allow from [CLIENT IP] to any port [PORT]/udp
sudo ufw allow from [HOST IP] to any port [PORT]/tcp
```
## Тестируем конфигурации:

>Для анализа проходящих пакетов, используем утилиту `tcpdump` 

### Конфигурация № 1:
<table border="1">
<tr><th>№ Тест-кейса</th><th>Выполняемые действия</th><th>Ожидаемый результат</th></tr>
<tr><td>001</td><td>Генерируем траффик только на клиенте</td><td>Получаем пакеты только с клиента</td></tr>
<tr><td>002</td><td>Генерируем траффик только на хосте</td><td>Не получаем пакеты</td></tr>
<tr><td>003</td><td>Генерируем траффик и на хосте и на клиенте одновременно</td><td>Получаем пакеты только с клиента</td></tr>
</table>

### Конфигурация № 2:
<table border="1">
<tr><th>№ Тест-кейса</th><th>Выполняемые действия</th><th>Ожидаемый результат</th></tr>
<tr><td>001</td><td>Генерируем траффик только на клиенте</td><td>Получаем пакеты только с клиента</td></tr>
<tr><td>002</td><td>Генерируем траффик только на хосте</td><td>Получаем пакеты только с хоста</td></tr>
<tr><td>003</td><td>Генерируем траффик на хосте и на клиенте одновременно</td><td>Получаем пакеты и с клиента и с хоста</td></tr>
</table>

### Конфигурация № 3:
<table border="1">
<tr><th>№ Тест-кейса</th><th>Выполняемые действия</th><th>Ожидаемый результат</th></tr>
<tr><td>001</td><td>Генерируем udp траффик только на клиенте</td><td>Получаем пакеты только с клиента</td></tr>
<tr><td>002</td><td>Генерируем tcp траффик только на клиенте</td><td>Не получаем пакеты</td></tr>
<tr><td>003</td><td>Генерируем tcp и udp траффик одновременно, только на клиенте </td><td>Получаем только udp пакеты с клиента</td></tr>
<tr><td>004</td><td>Генерируем udp траффик только на хосте</td><td>Не получаем пакеты</td></tr>
<tr><td>005</td><td>Генерируем tcp траффик только на хосте</td><td>Получаем пакеты только с хоста</td></tr>
<tr><td>006</td><td>Генерируем tcp и udp траффик одновременно, только на хосте </td><td>Получаем только tcp пакеты с хоста</td></tr>
<tr><td>007</td><td>Генерируем udp траффик на клиенте и на хосте</td><td>Получаем пакеты только с клиента</td></tr>
<tr><td>008</td><td>Генерируем tcp траффик на клиенте и на хосте</td><td>Получаем пакеты только с хоста</td></tr>
<tr><td>009</td><td>Генерируем tcp и udp траффик одновременно, и на клиенте и на хосте </td><td>Получаем только udp пакеты с клиента и только tcp пакеты с хоста</td></tr>
</table>
